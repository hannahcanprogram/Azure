-- Customers that have ever have their invoices attempted delivery for more than once, sort by date when the latest incident happensselect CustomerID, count(*) as attampts, max(cast(ConfirmedDeliveryTime as date) ) as datesfrom Sales.Invoiceswhere json_value(ReturnedDeliveryData,'$.Events[1].Comment')  is not nullgroup by CustomerIDhaving count(*) >1order by  max(cast(ConfirmedDeliveryTime as date) ) desc-- List of Sales People and total numbers of whose orders that the delivery date is more than 7 days later than the order date.--normal group byselect temp2.FullName,       count(distinct temp2.OrderID) as cntfrom(select *from(select o.OrderID, o.SalespersonPersonID, p.FullName, datediff(day,cast(o.OrderDate as date),cast(si.ConfirmedDeliveryTime as date)) as delivery_datesfrom Sales.Orders o join Sales.Invoices si on o.OrderID = si.OrderID and o.CustomerID = si.CustomerID                    join Application.People p on p.PersonID = o.SalespersonPersonID) tempwhere temp.delivery_dates > 7) temp2group by temp2.FullName-- Total Numbers of stockitems on sales, of each stockitem group, for each year existing in the database. [total_number, 2013,2014,2015,2016,2017...]--dynamic pivotingwith cte as (select sg.StockGroupName, year(si.ValidFrom) as eachyear, sum(distinct si.StockItemID) as total_num_itemfrom Warehouse.StockItems FOR SYSTEM_TIME ALL si join Warehouse.StockItemStockGroups ssg on ssg.StockItemID = si.StockItemID                     join Warehouse.StockGroups sg on sg.StockGroupID = ssg.StockGroupIDgroup by sg.StockGroupName, year(si.ValidFrom))select StockGroupName, [2013],[2014],[2015],[2016],[2017]from ctepivot(sum(total_num_item) for eachyear in ([2013],[2014],[2015],[2016],[2017]))as PivotTable;